name: ðŸš€ ãƒãƒ¼ãƒ¡ãƒ«ãƒ³å°èª¬ä¿å­˜ã‚¢ãƒ—ãƒª - è‡ªå‹•ãƒ†ã‚¹ãƒˆãƒ»ãƒ“ãƒ«ãƒ‰ãƒ»é…å¸ƒ

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'README_TEST.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      run_full_test:
        description: 'å®Œå…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‹'
        required: false
        default: 'false'
        type: boolean

jobs:
  test:
    name: ðŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆæ„Ÿæƒ³ãƒšãƒ¼ã‚¸è¤‡æ•°å–å¾—æ©Ÿèƒ½ï¼‰
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ§ª Run unit tests
      run: |
        python -m pytest test_comments_pagination.py -v --html=test-report.html --json-report --json-report-file=test-report.json
        
    - name: ðŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          test-report.html
          test-report.json
          
  functional-test:
    name: ðŸŒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆURLå¤‰æ›ãƒ»ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸŒ Run functional tests
      run: |
        python test_real_pagination_function.py > functional-test-results.txt 2>&1
        
    - name: ðŸ“Š Upload functional test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: functional-test-results
        path: functional-test-results.txt
        
  integration-test:
    name: ðŸ”— çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå®Ÿéš›ã®ãƒãƒ¼ãƒ¡ãƒ«ãƒ³ã‚µã‚¤ãƒˆæŽ¥ç¶šï¼‰
    runs-on: ubuntu-latest
    needs: [test, functional-test]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ”— Run integration tests with live site
      run: |
        mkdir -p test-downloads
        python test_actual_comments_pagination.py > integration-test-results.txt 2>&1
        
    - name: ðŸ“Š Upload integration test results and downloaded files
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          integration-test-results.txt
          test-downloads/
          test_integrated_comments.html
          
  build:
    name: ðŸ—ï¸ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãƒ“ãƒ«ãƒ‰ï¼ˆWindowsãƒ»Linuxå¯¾å¿œï¼‰
    runs-on: ubuntu-latest
    needs: [test, functional-test, integration-test]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ðŸ—ï¸ Build executable
      run: |
        ls -la *.spec
        pwd
        pyinstaller --clean HamelnBookDownloader.spec
        
    - name: ðŸ“¦ Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: HamelnBookDownloader-${{ github.sha }}
        path: dist/HamelnBookDownloader
        
  executable-test:
    name: ðŸš€ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«å‹•ä½œãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Download executable
      uses: actions/download-artifact@v4
      with:
        name: HamelnBookDownloader-${{ github.sha }}
        path: dist/
        
    - name: ðŸ”§ Make executable runnable
      run: chmod +x dist/HamelnBookDownloader
      
    - name: ðŸš€ Test executable functionality
      run: |
        mkdir -p executable-test-downloads
        # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆã¯ç°¡æ˜“ç‰ˆï¼ˆGUIç„¡åŠ¹åŒ–ï¼‰
        echo "å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        python test_executable_comments.py > executable-test-results.txt 2>&1 || true
        
    - name: ðŸ“Š Upload executable test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: executable-test-results
        path: |
          executable-test-results.txt
          executable-test-downloads/
          
  full-integration-test:
    name: ðŸŽ¯ å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå°èª¬ãƒ•ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¤œè¨¼ï¼‰
    runs-on: ubuntu-latest
    needs: executable-test
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_full_test == 'true')
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸŽ¯ Complete novel download test
      run: |
        mkdir -p full-test-downloads
        python test_full_integration.py > full-integration-test-results.txt 2>&1
        
    - name: ðŸ“Š Upload complete test results and downloads
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: full-integration-test-results
        path: |
          full-integration-test-results.txt
          full-test-downloads/
          
  summary-report:
    name: ðŸ“‹ ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [test, functional-test, integration-test, build, executable-test, full-integration-test]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate summary report
      run: |
        echo "# ðŸš€ Hameln Novel Saver - CI/CD Test Summary" > summary-report.md
        echo "" >> summary-report.md
        echo "## ðŸ“… Test Execution Date: $(date)" >> summary-report.md
        echo "## ðŸ”— Commit: ${{ github.sha }}" >> summary-report.md
        echo "## ðŸŒ¿ Branch: ${{ github.ref_name }}" >> summary-report.md
        echo "" >> summary-report.md
        echo "## ðŸ“Š Test Results Overview:" >> summary-report.md
        echo "" >> summary-report.md
        echo "| Test Type | Status |" >> summary-report.md
        echo "|-----------|--------|" >> summary-report.md
        echo "| Unit Tests | ${{ needs.test.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> summary-report.md
        echo "| Functional Tests | ${{ needs.functional-test.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> summary-report.md
        echo "| Integration Tests | ${{ needs.integration-test.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> summary-report.md
        echo "| Build | ${{ needs.build.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> summary-report.md
        echo "| Executable Test | ${{ needs.executable-test.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> summary-report.md
        echo "| Full Integration | ${{ needs.full-integration-test.result == 'success' && 'âœ… PASS' || (needs.full-integration-test.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAIL') }} |" >> summary-report.md
        echo "" >> summary-report.md
        echo "## ðŸŽ¯ Key Features Tested:" >> summary-report.md
        echo "- âœ… æ„Ÿæƒ³ãƒšãƒ¼ã‚¸ã®è¤‡æ•°ãƒšãƒ¼ã‚¸å–å¾—æ©Ÿèƒ½" >> summary-report.md
        echo "- âœ… å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ“ãƒ«ãƒ‰ã¨å‹•ä½œç¢ºèª" >> summary-report.md
        echo "- âœ… å®Ÿéš›ã®ãƒãƒ¼ãƒ¡ãƒ«ãƒ³ã‚µã‚¤ãƒˆã§ã®å‹•ä½œãƒ†ã‚¹ãƒˆ" >> summary-report.md
        echo "- âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯" >> summary-report.md
        echo "" >> summary-report.md
        echo "## ðŸ“¦ Generated Artifacts:" >> summary-report.md
        echo "- ðŸ§ª ãƒ†ã‚¹ãƒˆçµæžœãƒ¬ãƒãƒ¼ãƒˆ" >> summary-report.md
        echo "- ðŸ—ï¸ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ« (HamelnBookDownloader)" >> summary-report.md
        echo "- ðŸ“ å®Ÿéš›ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå°èª¬ãƒ•ã‚¡ã‚¤ãƒ«" >> summary-report.md
        echo "- ðŸ’¬ æ„Ÿæƒ³ãƒšãƒ¼ã‚¸ã®çµ±åˆçµæžœã‚µãƒ³ãƒ—ãƒ«" >> summary-report.md
        
    - name: ðŸ“Š Upload summary report
      uses: actions/upload-artifact@v4
      with:
        name: test-summary-report
        path: summary-report.md