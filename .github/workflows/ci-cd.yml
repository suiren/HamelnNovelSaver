name: CI/CD Pipeline for Hameln Novel Saver

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ðŸ§ª Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml cloudscraper undetected-chromedriver selenium pillow
        pip install pytest pytest-html pytest-json-report
        
    - name: ðŸ§ª Run unit tests
      run: |
        python -m pytest test_comments_pagination.py -v --html=test-report.html --json-report --json-report-file=test-report.json
        
    - name: ðŸ“Š Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          test-report.html
          test-report.json
          
  functional-test:
    name: ðŸŒ Functional Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml cloudscraper undetected-chromedriver selenium pillow
        
    - name: ðŸŒ Run functional tests
      run: |
        python test_real_pagination_function.py > functional-test-results.txt 2>&1
        
    - name: ðŸ“Š Upload functional test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: functional-test-results
        path: functional-test-results.txt
        
  integration-test:
    name: ðŸ”— Integration Tests (Live Site)
    runs-on: ubuntu-latest
    needs: [test, functional-test]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml cloudscraper undetected-chromedriver selenium pillow
        
    - name: ðŸ”— Run integration tests with live site
      run: |
        mkdir -p test-downloads
        python test_actual_comments_pagination.py > integration-test-results.txt 2>&1
        
    - name: ðŸ“Š Upload integration test results and downloaded files
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: |
          integration-test-results.txt
          test-downloads/
          test_integrated_comments.html
          
  build:
    name: ðŸ—ï¸ Build Executable
    runs-on: ubuntu-latest
    needs: [test, functional-test, integration-test]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml cloudscraper undetected-chromedriver selenium pillow
        pip install pyinstaller
        
    - name: ðŸ—ï¸ Build executable
      run: |
        pyinstaller --clean HamelnBookDownloader.spec
        
    - name: ðŸ“¦ Upload executable
      uses: actions/upload-artifact@v3
      with:
        name: HamelnBookDownloader-${{ github.sha }}
        path: dist/HamelnBookDownloader
        
  executable-test:
    name: ðŸš€ Executable Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Download executable
      uses: actions/download-artifact@v3
      with:
        name: HamelnBookDownloader-${{ github.sha }}
        path: dist/
        
    - name: ðŸ”§ Make executable runnable
      run: chmod +x dist/HamelnBookDownloader
      
    - name: ðŸš€ Test executable functionality
      run: |
        mkdir -p executable-test-downloads
        # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆã¯ç°¡æ˜“ç‰ˆï¼ˆGUIç„¡åŠ¹åŒ–ï¼‰
        echo "å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        python test_executable_comments.py > executable-test-results.txt 2>&1 || true
        
    - name: ðŸ“Š Upload executable test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: executable-test-results
        path: |
          executable-test-results.txt
          executable-test-downloads/
          
  full-integration-test:
    name: ðŸŽ¯ Complete Novel Download Test
    runs-on: ubuntu-latest
    needs: executable-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml cloudscraper undetected-chromedriver selenium pillow
        
    - name: ðŸŽ¯ Complete novel download test
      run: |
        mkdir -p full-test-downloads
        python -c "
from hameln_scraper_final import HamelnFinalScraper
import os

scraper = HamelnFinalScraper()
test_url = 'https://syosetu.org/novel/378070/'
output_dir = 'full-test-downloads'

print('Complete novel download test starting...')
try:
    result = scraper.save_novel(test_url, output_dir)
    if result:
        print(f'âœ… Complete download successful: {result}')
        
        # Check if comments were saved with multiple pages
        import glob
        comment_files = glob.glob(os.path.join(output_dir, '**/æ„Ÿæƒ³*.html'), recursive=True)
        if comment_files:
            print(f'âœ… Comments files found: {len(comment_files)}')
            for comment_file in comment_files:
                size = os.path.getsize(comment_file)
                print(f'  - {os.path.basename(comment_file)}: {size} bytes')
                
                # Check if it contains multiple pages indication
                with open(comment_file, 'r', encoding='utf-8') as f:
                    content = f.read()
                    if 'çµ±åˆè¡¨ç¤º' in content:
                        print(f'  âœ… Multiple pages integrated in {os.path.basename(comment_file)}')
                    else:
                        print(f'  â„¹ï¸ Single page comments in {os.path.basename(comment_file)}')
        else:
            print('âš ï¸ No comment files found')
    else:
        print('âŒ Complete download failed')
except Exception as e:
    print(f'âŒ Error during download: {e}')
    import traceback
    traceback.print_exc()
" > full-integration-test-results.txt 2>&1
        
    - name: ðŸ“Š Upload complete test results and downloads
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: full-integration-test-results
        path: |
          full-integration-test-results.txt
          full-test-downloads/
          
  summary-report:
    name: ðŸ“‹ Test Summary Report
    runs-on: ubuntu-latest
    needs: [test, functional-test, integration-test, build, executable-test, full-integration-test]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate summary report
      run: |
        echo "# ðŸš€ Hameln Novel Saver - CI/CD Test Summary" > summary-report.md
        echo "" >> summary-report.md
        echo "## ðŸ“… Test Execution Date: $(date)" >> summary-report.md
        echo "## ðŸ”— Commit: ${{ github.sha }}" >> summary-report.md
        echo "## ðŸŒ¿ Branch: ${{ github.ref_name }}" >> summary-report.md
        echo "" >> summary-report.md
        echo "## ðŸ“Š Test Results Overview:" >> summary-report.md
        echo "" >> summary-report.md
        echo "| Test Type | Status |" >> summary-report.md
        echo "|-----------|--------|" >> summary-report.md
        echo "| Unit Tests | ${{ needs.test.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> summary-report.md
        echo "| Functional Tests | ${{ needs.functional-test.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> summary-report.md
        echo "| Integration Tests | ${{ needs.integration-test.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> summary-report.md
        echo "| Build | ${{ needs.build.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> summary-report.md
        echo "| Executable Test | ${{ needs.executable-test.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> summary-report.md
        echo "| Full Integration | ${{ needs.full-integration-test.result == 'success' && 'âœ… PASS' || (needs.full-integration-test.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAIL') }} |" >> summary-report.md
        echo "" >> summary-report.md
        echo "## ðŸŽ¯ Key Features Tested:" >> summary-report.md
        echo "- âœ… æ„Ÿæƒ³ãƒšãƒ¼ã‚¸ã®è¤‡æ•°ãƒšãƒ¼ã‚¸å–å¾—æ©Ÿèƒ½" >> summary-report.md
        echo "- âœ… å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ“ãƒ«ãƒ‰ã¨å‹•ä½œç¢ºèª" >> summary-report.md
        echo "- âœ… å®Ÿéš›ã®ãƒãƒ¼ãƒ¡ãƒ«ãƒ³ã‚µã‚¤ãƒˆã§ã®å‹•ä½œãƒ†ã‚¹ãƒˆ" >> summary-report.md
        echo "- âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯" >> summary-report.md
        echo "" >> summary-report.md
        echo "## ðŸ“¦ Generated Artifacts:" >> summary-report.md
        echo "- ðŸ§ª ãƒ†ã‚¹ãƒˆçµæžœãƒ¬ãƒãƒ¼ãƒˆ" >> summary-report.md
        echo "- ðŸ—ï¸ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ« (HamelnBookDownloader)" >> summary-report.md
        echo "- ðŸ“ å®Ÿéš›ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå°èª¬ãƒ•ã‚¡ã‚¤ãƒ«" >> summary-report.md
        echo "- ðŸ’¬ æ„Ÿæƒ³ãƒšãƒ¼ã‚¸ã®çµ±åˆçµæžœã‚µãƒ³ãƒ—ãƒ«" >> summary-report.md
        
    - name: ðŸ“Š Upload summary report
      uses: actions/upload-artifact@v3
      with:
        name: test-summary-report
        path: summary-report.md