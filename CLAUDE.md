# ハーメルン小説保存アプリケーション

## 🚨 **CLAUDE必読チェックリスト** 🚨

**⚠️ コーディングタスクを受けた場合、以下を例外なく実行せよ ⚠️**

### 📋 **必須手順（毎回確認）**

1. **[ ] TDD手順の確認**
   - 「Development Philosophy」セクションのTDD手順を読む
   - テスト駆動開発の強制適用ルールを確認する

2. **[ ] テスト作成の優先**
   - 実装コードを書く前に必ずテストを作成
   - テストが失敗することを確認してから実装開始
   - バグ修正時は再現テストを最初に作成

3. **[ ] TodoWriteツールでの進捗管理**
   - 最初のタスクを「TDD手順確認とテスト作成」にする
   - 各段階の完了を必ず記録する

4. **[ ] 日本語での応答確認**
   - Conversation Guidelinesの日本語応答ルールを確認

### 🛑 **禁止事項**
- ❌ テストなしでの実装コード作成
- ❌ TDD手順のスキップ
- ❌ 「簡単だから」という理由での手順省略
- ❌ 英語での応答

### ✅ **このチェックリストを見た証明**
コーディングタスク開始時に「CLAUDE.mdチェックリスト確認完了」と宣言すること

---

## 概要
ハーメルン（https://syosetu.org）の小説をローカルにHTML形式で保存するWebスクレイピングツールです。

## 使用方法

### コマンドライン版
```bash
python hameln_scraper_final.py
```

### GUI版
```bash
python hameln_gui.py
```

## 重要な注意事項

### ハーメルンアクセスについて

🚨 **CRITICAL**: ハーメルン（syosetu.org）はCloudflareで保護されています 🚨
- 直接的なHTTPリクエスト（curl、requests等）は失敗します
- 必ずCloudscraper或いはundetected-chromedriverを使用してください

ハーメルンは強力なbot検知システムを使用しているため、アクセス時に以下の問題が発生する可能性があります：

1. **403 Forbidden エラー**
   - bot検知システムによる自動アクセス拒否
   - 対策：User-Agentローテーション、適切な待機時間の設定

2. **429 Too Many Requests エラー**
   - 短時間に多数のリクエストを送信した場合
   - 対策：リクエスト間隔を長くする（30秒以上推奨）

3. **Cloudflare認証**
   - 場合によってはブラウザ認証が必要
   - 対策：undetected-chromedriver使用、より長い待機時間

### アクセス回避機能

#### 実装済み機能
- **CloudScraper**: Cloudflareの初期認証をバイパス
- **User-Agentローテーション**: 5種類のブラウザーを模擬
- **適応的待機時間**: 失敗時に段階的に待機時間を延長
- **undetected-chromedriver**: より高度なbot検知回避

#### 推奨設定
- 章間の待機時間: 3-8秒（章数に応じて調整）
- 失敗時の再試行間隔: 5-30秒
- 最大再試行回数: 3回

### 本文抽出について

#### 2024年版対応
ハーメルンのHTML構造変更に対応し、以下のセレクターを使用：
- `div.section1` - `div.section9`: 主要な本文クラス
- `div.p-novel-text`, `div.novel-text`: 新しい本文クラス
- フォールバック機能：最長テキスト要素を自動選択

#### 見た目の完全再現
- 元のHTML構造を保持
- CSS、JavaScript、画像を含む完全保存
- 不要なトラッキング要素のみを削除

## トラブルシューティング

### よくある問題

1. **「メインページの取得に失敗しました」**
   - 原因：bot検知による拒否
   - 対策：時間をおいて再試行、VPN使用検討

2. **「本文がタイトルと作者のみ」**
   - 原因：新しいHTML構造への未対応
   - 対策：デバッグログを確認し、新しいセレクターを追加

3. **「章リンクが見つかりません」**
   - 原因：単一ページ作品または構造変更
   - 対策：単一ページとして処理される

### デバッグ情報

#### ログファイル
- `hameln_debug.log`: 詳細なデバッグ情報
- `hameln_gui.log`: GUI版のログ
- `hameln_scraper.log`: コマンドライン版のログ

#### 確認すべき情報
1. レスポンスステータスコード
2. 取得したHTMLのタイトル
3. 見つかった要素数
4. 除外キーワードの検出状況

## 技術詳細

### 依存関係
```
requests>=2.31.0
beautifulsoup4>=4.12.0
lxml>=4.9.0
cloudscraper>=1.2.71
undetected-chromedriver>=3.5.4
selenium>=4.15.0
Pillow>=10.0.0
```

### アーキテクチャ
- **CloudScraper**: 高速な初期取得
- **Selenium**: 高度なJavaScript処理
- **BeautifulSoup**: HTMLパースと構造解析
- **適応的セレクター**: 複数のHTML構造に対応
- **Brotli圧縮**: 2024年対応のハーメルン圧縮形式

## 実行ファイルの作成

### 必要なツール
```bash
pip install pyinstaller
```

### ビルド手順
1. **Windows**:
   ```cmd
   build_hameln.bat
   ```

2. **Linux/Mac**:
   ```bash
   ./build_hameln.sh
   ```

### 手動ビルド
```bash
# 必要なモジュールをインストール
pip install brotli cloudscraper undetected-chromedriver selenium beautifulsoup4 lxml requests pillow

# ビルド実行
pyinstaller --clean HamelnNovelSaver.spec
```

### 作成されるファイル
- `dist/HamelnNovelSaver.exe` (Windows)
- `dist/HamelnNovelSaver` (Linux/Mac)

### 実行時の注意点
- exeファイルは署名されていないため、Windows Defenderで「作成者が確認できません」と表示される場合があります
- 「詳細情報」→「実行」で実行可能です
- 企業環境では管理者に相談してください

## 法的注意事項
- 個人使用の範囲内での利用を想定
- 過度なアクセスによるサーバー負荷をかけないよう注意
- 著作権法および利用規約を遵守すること

## 更新履歴
- 2024年版: section1-9クラス対応
- 外部ログファイル出力機能追加
- User-Agentローテーション機能追加
- 見た目完全再現機能追加
- 2025年7月版: 小説情報・感想保存機能追加（Norton検出回避のため無効化中）

## 新機能の有効化方法

### 小説情報・感想保存機能
Norton検出問題が解決した場合、以下で再有効化可能：

```python
# hameln_scraper_final.py (40-41行目)
self.enable_novel_info_saving = True   # 小説情報保存機能
self.enable_comments_saving = True     # 感想保存機能

# hameln_gui.py (235-236行目)  
self.scraper.enable_novel_info_saving = True   # 小説情報保存を有効化
self.scraper.enable_comments_saving = True     # 感想保存を有効化
```

### 右クリック貼り付け機能
hameln_gui.pyで既に有効化済み（Norton検出に影響なし）

## Conversation Guidelines

**重要**: このプロジェクトではすべての会話を日本語で行います。
- 最初の挨拶から最後の返答まで、すべて日本語で応答する
- 英語での回答は絶対に行わない
- コードコメントや変数名は英語でも構わないが、説明は必ず日本語で行う

## 🚨 修正作業の重要指針

**必読**: 任意の修正作業前に `MODIFICATION_GUIDELINES.md` を参照すること
- 指摘された問題のみを修正し、「ついでに」修正は禁止
- 最小変更の法則を厳守する
- 副作用による新たな問題発生を防ぐ

## Gemini CLI 連携ガイド

### 目的
ユーザーが **「Geminiと相談しながら進めて」** と指示した場合、
Claude は以降のタスクを **Gemini CLI** と協調しながら進める。

### トリガー
- 正規表現: `/Gemini.*相談しながら/`

### 基本フロー
1. **PROMPT 生成**
   Claude はユーザーの要件を1つのテキストにまとめ、環境変数 `$PROMPT` に格納

2. **Gemini CLI 呼び出し**
```bash
echo "$PROMPT" | gemini
```

3. **結果の統合**
   - Gemini の回答を提示
   - Claude の追加分析・コメントを付加

## Development Philosophy

### 🚨 **Claude必読警告** 🚨
**このセクションを読まずにコーディングすることは禁止されている**
**TDD手順の無視は過去に複数回の問題を引き起こした**

### Test-Driven Development (TDD)

- 原則としてテスト駆動開発（TDD）で進める
- 期待される入出力に基づき、まずテストを作成する
- 実装コードは書かず、テストのみを用意する
- テストを実行し、失敗を確認する
- テストが正しいことを確認できた段階でコミットする
- その後、テストをパスさせる実装を進める
- 実装中はテストを変更せず、コードを修正し続ける
- すべてのテストが通過するまで繰り返す

### Critical Development Process (重要な開発プロセス)

**注意**: 以下のプロセスは必ず遵守すること。過去のセッションで要件誤解と既存機能破損が発生したため。

#### 1. 要件の明確化 (Requirement Clarification)
- **修正前の再確認**: ユーザー要求を具体例で確認
- **影響範囲の事前説明**: 修正により影響する機能を列挙
- **承認の取得**: 明確な承認を得てから作業開始

#### 2. 段階的修正 (Incremental Changes)
- **最小単位での修正**: 一度に一つの機能のみ修正
- **各段階でのテスト**: 修正後に既存機能の動作確認
- **ロールバック準備**: 問題発生時の即座の復旧体制

#### 3. 影響範囲の分析 (Impact Analysis)
- **依存関係の確認**: 修正対象の依存機能を事前調査
- **回帰テスト**: 既存機能が破損していないことを確認
- **エンドツーエンドテスト**: 実際のユーザー操作での動作確認

#### 4. テスト駆動開発の強制適用 (Mandatory TDD Application)

**重要**: 2025年7月14日のセッションでTDD手順が無視され、バグ修正が不完全になった。以下を必ず実行：

##### 新機能開発時
- **例外なしでTDD適用**: どんなに小さな機能でもテストを先に作成
- **テスト失敗の確認**: 実装前に必ずテストが失敗することを確認
- **実装後のテスト通過**: すべてのテストが通過するまで実装を継続

##### バグ修正時
- **再現テストの作成**: バグを再現するテストケースを最初に作成
- **修正前のテスト実行**: バグが確実に再現されることを確認
- **修正後の検証**: テストが通過し、他の機能に影響がないことを確認

##### セッション継続性の確保
- **継続セッションでもTDD適用**: 前セッションからの継続でもテスト駆動を徹底
- **既存コード修正時**: 部分修正でも該当部分のテストを作成してから修正
- **緊急修正の場合**: 修正後に必ずテストを追加し、将来の回帰を防止
- **完全な動作確認**: 実際のHTMLファイルをブラウザで確認

詳細な改善策は DEVELOPMENT_PROCESS.md を参照すること。