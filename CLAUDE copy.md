# ハーメルン小説保存アプリケーション

## 概要
ハーメルン（https://syosetu.org）の小説をローカルにHTML形式で保存するWebスクレイピングツールです。

## 使用方法

### コマンドライン版
```bash
python hameln_scraper_final.py
```

### GUI版
```bash
python hameln_gui.py
```

## 重要な注意事項

### ハーメルンアクセスについて
ハーメルンは強力なbot検知システムを使用しているため、アクセス時に以下の問題が発生する可能性があります：

1. **403 Forbidden エラー**
   - bot検知システムによる自動アクセス拒否
   - 対策：User-Agentローテーション、適切な待機時間の設定

2. **429 Too Many Requests エラー**
   - 短時間に多数のリクエストを送信した場合
   - 対策：リクエスト間隔を長くする（30秒以上推奨）

3. **Cloudflare認証**
   - 場合によってはブラウザ認証が必要
   - 対策：undetected-chromedriver使用、より長い待機時間

### アクセス回避機能

#### 実装済み機能
- **CloudScraper**: Cloudflareの初期認証をバイパス
- **User-Agentローテーション**: 5種類のブラウザーを模擬
- **適応的待機時間**: 失敗時に段階的に待機時間を延長
- **undetected-chromedriver**: より高度なbot検知回避

#### 推奨設定
- 章間の待機時間: 3-8秒（章数に応じて調整）
- 失敗時の再試行間隔: 5-30秒
- 最大再試行回数: 3回

### 本文抽出について

#### 2024年版対応
ハーメルンのHTML構造変更に対応し、以下のセレクターを使用：
- `div.section1` - `div.section9`: 主要な本文クラス
- `div.p-novel-text`, `div.novel-text`: 新しい本文クラス
- フォールバック機能：最長テキスト要素を自動選択

#### 見た目の完全再現
- 元のHTML構造を保持
- CSS、JavaScript、画像を含む完全保存
- 不要なトラッキング要素のみを削除

## トラブルシューティング

### よくある問題

1. **「メインページの取得に失敗しました」**
   - 原因：bot検知による拒否
   - 対策：時間をおいて再試行、VPN使用検討

2. **「本文がタイトルと作者のみ」**
   - 原因：新しいHTML構造への未対応
   - 対策：デバッグログを確認し、新しいセレクターを追加

3. **「章リンクが見つかりません」**
   - 原因：単一ページ作品または構造変更
   - 対策：単一ページとして処理される

### デバッグ情報

#### ログファイル
- `hameln_debug.log`: 詳細なデバッグ情報
- `hameln_gui.log`: GUI版のログ
- `hameln_scraper.log`: コマンドライン版のログ

#### 確認すべき情報
1. レスポンスステータスコード
2. 取得したHTMLのタイトル
3. 見つかった要素数
4. 除外キーワードの検出状況

## 技術詳細

### 依存関係
```
requests>=2.31.0
beautifulsoup4>=4.12.0
lxml>=4.9.0
cloudscraper>=1.2.71
undetected-chromedriver>=3.5.4
selenium>=4.15.0
Pillow>=10.0.0
```

### アーキテクチャ
- **CloudScraper**: 高速な初期取得
- **Selenium**: 高度なJavaScript処理
- **BeautifulSoup**: HTMLパースと構造解析
- **適応的セレクター**: 複数のHTML構造に対応

## 法的注意事項
- 個人使用の範囲内での利用を想定
- 過度なアクセスによるサーバー負荷をかけないよう注意
- 著作権法および利用規約を遵守すること

## 更新履歴
- 2024年版: section1-9クラス対応
- 外部ログファイル出力機能追加
- User-Agentローテーション機能追加
- 見た目完全再現機能追加

## Conversation Guidelines

**重要**: このプロジェクトではすべての会話を日本語で行います。
- 最初の挨拶から最後の返答まで、すべて日本語で応答する
- 英語での回答は絶対に行わない
- コードコメントや変数名は英語でも構わないが、説明は必ず日本語で行う

## Gemini CLI 連携ガイド

### 目的
ユーザーが **「Geminiと相談しながら進めて」** と指示した場合、
Claude は以降のタスクを **Gemini CLI** と協調しながら進める。

### トリガー
- 正規表現: `/Gemini.*相談しながら/`

### 基本フロー
1. **PROMPT 生成**
   Claude はユーザーの要件を1つのテキストにまとめ、環境変数 `$PROMPT` に格納

2. **Gemini CLI 呼び出し**
```bash
echo "$PROMPT" | gemini
```

3. **結果の統合**
   - Gemini の回答を提示
   - Claude の追加分析・コメントを付加

## Development Philosophy

### Test-Driven Development (TDD)

- 原則としてテスト駆動開発（TDD）で進める
- 期待される入出力に基づき、まずテストを作成する
- 実装コードは書かず、テストのみを用意する
- テストを実行し、失敗を確認する
- テストが正しいことを確認できた段階でコミットする
- その後、テストをパスさせる実装を進める
- 実装中はテストを変更せず、コードを修正し続ける
- すべてのテストが通過するまで繰り返す