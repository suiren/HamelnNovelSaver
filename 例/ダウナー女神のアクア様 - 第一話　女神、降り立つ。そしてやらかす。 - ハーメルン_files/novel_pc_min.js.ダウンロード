function ShowLength(t,e){e=(e=(e=e.replace(/\r\n/g,"")).replace(/(\n|\r)/g,"")).replace(/( |　)/g,""),document.getElementById(t).innerHTML=e.length+"文字"}function changeView(){var t=new Date;t.setTime(t.getTime()+2592e7),$.cookie("viewmode","sp",{path:"/",domain:".syosetu.org",expires:t}),location.reload(!0)}var url_path=location.pathname,url_list=url_path.match(/^\/.*\/([0-9]*)\/([0-9]*)\.html$/),nid,volume;url_list&&3==url_list.length?(nid=url_list[1],volume=url_list[2]):((url_list=url_path.match(/^\/.*\/([0-9]*)\/$/))&&2==url_list.length&&(nid=url_list[1]),volume=1),$.cookie("style0111")&&$("#styleBase").attr({href:$.cookie("style0111").replace("http:","https:").replace("hamelnovel.com","img.syosetu.org")}),$.cookie("style02")&&$("#styleRuby").attr({href:$.cookie("style02").replace("http:","https:").replace("hamelnovel.com","img.syosetu.org")});var css=function(){var t=document.createElement("style");t.setAttribute("type","text/css"),document.getElementsByTagName("head").item(0).appendChild(t);var e=t.sheet;return function(t,i){e.insertRule(t+"{"+i+"}",0)}}(),getBright=function(colorcode,mod){if(void 0===colorcode)return 0;colorcode.match(/^#/)&&(colorcode=colorcode.slice(1));var keta=Math.floor(colorcode.length/3);if(keta<1)return!1;for(var rgb=[],i=0;i<3;i++)rgb.push(parseInt(colorcode.slice(keta*i,keta*(i+1)),16));var rmod=mod.r||1,gmod=mod.g||1,bmod=mod.b||1,bright;return Math.max(rgb[0]*rmod,rgb[1]*gmod,rgb[2]*bmod)/255};$.cookie.json=!0;var data={};try{$.cookie("ss_setting")&&(data=$.cookie("ss_setting"))}catch(e){$.cookie("ss_setting",data,{expires:3650,path:"/",domain:".syosetu.org"})}if($.cookie("ss_setting")){var mod={r:.9,g:.8,b:.4};getBright(data.bgcolor,mod)<getBright(data.fontcolor,mod)&&(css("body.night body.night","background-color:"+data.bgcolor+";"),css("body.night #container","background-color:"+data.bgcolor+";"),css("body.night #footer address","color:"+data.fontcolor+";"),css("body.night .footnote_tip","background-color:"+data.bgcolor+";"),css("body.night .footnote_tip","border-color:"+data.fontcolor+";"),css("body.night #header .topicPath","background-color:"+data.bgcolor+";"),css("body.night #footer_bar","background-color:"+data.bgcolor+";"),css("body.night div.ss :not(.bgcolor)","color:"+data.fontcolor+";"),css("body.night #footer_bar","color:"+data.fontcolor+";"),css("body.night div.ss a","color:"+data.linkcolor+";"),css("body.night div.novelnavi a","background-color:"+data.bgcolor+";"),css("body.night ul.guide a","color:"+data.linkcolor+";"),css("body.night ol.topicPath a","color:"+data.linkcolor+";"),css("body.night #footer ul.nl a","color:"+data.linkcolor+";"),css("body.night div.ss a:link","color:"+data.linkcolor+";"),css("body.night ul.guide a:link","color:"+data.linkcolor+";"),css("body.night ol.topicPath a:link","color:"+data.linkcolor+";"),css("body.night #footer ul.nl a:link","color:"+data.linkcolor+";"),css("body.night div.ss a:visited","color:"+data.linkcolor2+";"),css("body.night ul.guide a:visited","color:"+data.linkcolor2+";"),css("body.night ol.topicPath a:visited","color:"+data.linkcolor2+";"),css("body.night #footer ul.nl a:visited","color:"+data.linkcolor2+";")),"#ffffff"!==data.bgcolor&&"ffffff"!==data.bgcolor&&css("body","background-color:"+data.bgcolor+";"),css("#container","background-color:"+data.bgcolor+";"),css("#footer address","color:"+data.fontcolor+";"),css(".footnote_tip","background-color:"+data.bgcolor+";"),css(".footnote_tip","border-color:"+data.fontcolor+";"),css("#header .topicPath","background-color:"+data.bgcolor+";"),css("#footer_bar","background-color:"+data.bgcolor+";"),css("div.ss","color:"+data.fontcolor+";"),css("#footer_bar","color:"+data.fontcolor+";"),css("div.ss a","color:"+data.linkcolor+";"),css("div.novelnavi a","background-color:"+data.bgcolor+";"),css("ul.guide a","color:"+data.linkcolor+";"),css("ol.topicPath a","color:"+data.linkcolor+";"),css("#footer ul.nl a","color:"+data.linkcolor+";"),css("div.ss a:visited","color:"+data.linkcolor2+";"),css("ul.guide a:visited","color:"+data.linkcolor2+";"),css("ol.topicPath a:visited","color:"+data.linkcolor2+";"),css("#footer ul.nl a:visited","color:"+data.linkcolor2+";"),$((function(){$(document).on("click",".maegaki_view_toggle",(function(){return $("#maegaki").toggle(),$("#maegaki_open").toggle(),!1})),$(document).on("click",".atogaki_view_toggle",(function(){return $("#atogaki").toggle(),$("#atogaki_open").toggle(),!1})),0==data.special_tag&&1!=data.correct&&($(".tag_speak").removeAttr("onclick"),$(".tag_blink,.tag_fade,.tag_blur,.tag_opacity,.strokecolor,.bordercolor,.bgcolor,.webfont_subset,.color,.tag_vib,.tag_shake,.tag_telop,.tag_box,.tag_text").removeAttr("style"),$(".tag_blink,.tag_vib,.tag_shake,.tag_fade,.inner_marquee,.bold,.italic,.strike,.underline,.small,.big,.xsmall,.xbig,.center,.right,.left,.bordercolor,.color,.strokecolor,.bgcolor,.webfont_subset,.tag_telop,.tag_box,.tag_text").removeAttr("class"))}))}function mult(str,n){for(var res="";n>0;res+=str,n--);return res}$.cookie("ss_setting")&&(data.bgcolor&&css("div.ss","width:"+data.width+"%;"),data.fontsize&&css("div.ss","font-size:"+data.fontsize+"%"),data.lineheight&&css("div.ss","line-height:"+data.lineheight+"%;"),data.fontstyle&&css("#container","font-family:"+data.fontstyle+";"),1<=data.maegaki&&css("#maegaki","display:none;"),1<=data.atogaki&&css("#atogaki","display:none;"),2==data.maegaki&&css("#maegaki_open","display:block;"),2==data.atogaki&&css("#atogaki_open","display:block;"),1==data.enquete&&css("#enquete_box","display:none !important;")),$((function(){function t(t){$("#"+t+" .display_text .footnote_number").replaceWith((function(){var index=$(".display_text .footnote_number").index(this);$(this).replaceWith("《ref》"+$(".footnote_text").eq(index).html()+"《/ref》"),$(".footnote_text").eq(index).addClass("original_footnote_text"),$(".footnote_text").eq(index).removeClass("footnote_text")})),$("#"+t+" .original_text .footnote_number").replaceWith((function(){$(this).replaceWith("《ref》"+$(".original_footnote_text").eq(0).html()+"《/ref》"),$(".original_footnote_text").eq(0).removeClass("original_footnote_text")})),$("#"+t+" .bold").replaceWith((function(){$(this).replaceWith("《b》"+$(this).html()+"《/b》")})),$("#"+t+" .italic").replaceWith((function(){$(this).replaceWith("《i》"+$(this).html()+"《/i》")})),$("#"+t+" .strike").replaceWith((function(){$(this).replaceWith("《s》"+$(this).html()+"《/s》")})),$("#"+t+" .underline").replaceWith((function(){$(this).replaceWith("《u》"+$(this).html()+"《/u》")})),$("#"+t+" .small").replaceWith((function(){$(this).replaceWith("《small》"+$(this).html()+"《/small》")})),$("#"+t+" .big").replaceWith((function(){$(this).replaceWith("《big》"+$(this).html()+"《/big》")})),$("#"+t+" .xsmall").replaceWith((function(){$(this).replaceWith("《xsmall》"+$(this).html()+"《/xsmall》")})),$("#"+t+" .xbig").replaceWith((function(){$(this).replaceWith("《xbig》"+$(this).html()+"《/xbig》")})),$("#"+t+" .left").replaceWith((function(){$(this).replaceWith("《left》"+$(this).html()+"《/left》")})),$("#"+t+" .center").replaceWith((function(){$(this).replaceWith("《center》"+$(this).html()+"《/center》")})),$("#"+t+" .right").replaceWith((function(){$(this).replaceWith("《right》"+$(this).html()+"《/right》")})),$("#"+t+" sup").replaceWith((function(){$(this).replaceWith("《sup》"+$(this).html()+"《/sup》")})),$("#"+t+" sub").replaceWith((function(){$(this).replaceWith("《sub》"+$(this).html()+"《/sub》")})),$("#"+t+" hr").replaceWith((function(){$(this).replaceWith("《hr》")})),$("#"+t+" .jump_link").replaceWith((function(){var t=[],e=/([0-9]{0,4})(\.html)?(#jump\.)?([a-zA-Z0-9]{0,10})/,i=$(this).attr("href");if(t=e.exec(i)){var a=t[1],o=t[4];o&&(o="#"+o)}$(this).replaceWith("《link:"+a+o+"》"+$(this).html()+"《/link》")})),$("#"+t+" span [id^='jump']").replaceWith((function(){var t=[],e=/jump\.([a-zA-Z0-9]{1,10})/,i=$(this).attr("id");(t=e.exec(i))&&$(this).replaceWith("《id:"+t[1]+"》")})),$("#"+t+" .webfont_subset").replaceWith((function(){var t=[],e=/f-(u?[0-9]{1,})/,i=$(this).css("font-family");(t=e.exec(i))&&$(this).replaceWith("《font:"+t[1]+"》"+$(this).html()+"《/font》")})),$("#"+t+" .color").replaceWith((function(){var color=$.Color($(this).css("color"));color.is("white")?$(this).replaceWith("《white》"+$(this).html()+"《/white》"):color.is("gray")?$(this).replaceWith("《gray》"+$(this).html()+"《/gray》"):color.is("darkgray")?$(this).replaceWith("《darkgray》"+$(this).html()+"《/darkgray》"):color.is("black")?$(this).replaceWith("《black》"+$(this).html()+"《/black》"):color.is("brown")?$(this).replaceWith("《brown》"+$(this).html()+"《/brown》"):color.is("darkbrown")?$(this).replaceWith("《darkbrown》"+$(this).html()+"《/darkbrown》"):color.is("red")?$(this).replaceWith("《red》"+$(this).html()+"《/red》"):color.is("darkred")?$(this).replaceWith("《darkred》"+$(this).html()+"《/darkred》"):color.is("gold")?$(this).replaceWith("《gold》"+$(this).html()+"《/gold》"):color.is("orange")?$(this).replaceWith("《orange》"+$(this).html()+"《/orange》"):color.is("darkorange")?$(this).replaceWith("《darkorange》"+$(this).html()+"《/darkorange》"):color.is("green")?$(this).replaceWith("《green》"+$(this).html()+"《/green》"):color.is("darkgreen")?$(this).replaceWith("《darkgreen》"+$(this).html()+"《/darkgreen》"):color.is("blue")?$(this).replaceWith("《blue》"+$(this).html()+"《/blue》"):color.is("darkblue")?$(this).replaceWith("《darkblue》"+$(this).html()+"《/darkblue》"):color.is("purple")?$(this).replaceWith("《purple》"+$(this).html()+"《/purple》"):color.is("pink")?$(this).replaceWith("《pink》"+$(this).html()+"《/pink》"):color.is("transparent")?$(this).replaceWith("《transparent》"+$(this).html()+"《/transparent》"):$(this).replaceWith("《color:"+color.toHexString()+"》"+$(this).html()+"《/color》")})),$("#"+t+" .bgcolor").replaceWith((function(){var color=$.Color($(this).css("background-color"));$(this).replaceWith("《bgcolor:"+color.toHexString()+"》"+$(this).html()+"《/bgcolor》")})),$("#"+t+" .bordercolor").replaceWith((function(){var color=$.Color($(this).css("border-color"));$(this).replaceWith("《bordercolor:"+color.toHexString()+"》"+$(this).html()+"《/bordercolor》")})),$("#"+t+" .strokecolor").replaceWith((function(){var color=$.Color($(this).css("-webkit-text-stroke-color"));$(this).replaceWith("《edge:"+color.toHexString()+"》"+$(this).html()+"《/edge》")})),$("#"+t+" .tag_opacity").replaceWith((function(){$(this).replaceWith("《opacity:"+$(this).data("num")+"》"+$(this).html()+"《/opacity》")})),$("#"+t+" .tag_blur").replaceWith((function(){$(this).replaceWith("《blur:"+$(this).data("num")+"》"+$(this).html()+"《/blur》")})),$("#"+t+" .tag_blink").replaceWith((function(){$(this).replaceWith("《blink:"+$(this).data("num")+"》"+$(this).html()+"《/blink》")})),$("#"+t+" .tag_fade").replaceWith((function(){$(this).replaceWith("《fade:"+$(this).data("num")+"》"+$(this).html()+"《/fade》")})),$("#"+t+" .tag_shake").replaceWith((function(){var t=[],e=/shake-([1])/,i=$(this).attr("class");(t=e.exec(i))&&$(this).replaceWith("《shake:"+t[1]+"》"+$(this).html()+"《/shake》")})),$("#"+t+" .tag_vib").replaceWith((function(){var t=[],e=/vib-([1])/,i=$(this).attr("class");(t=e.exec(i))&&$(this).replaceWith("《vib:"+t[1]+"》"+$(this).html()+"《/vib》")})),$("#"+t+" .tag_text").replaceWith((function(){var option=$(this).data("option");$(this).replaceWith("《text:"+option+"》"+$(this).html()+"《/text》")}))}var e,i;$(window).scroll((function(){return 1==data.like||(null==document.getElementById("login_user")||($(".likevote_selected_line").removeClass("likevote_selected_line"),void $(".likevote_tip").remove()))})),$(document).on("click",".likevote_tip",(function(e){return likevote_text=$(".likevote_text"),1==likevote_text.data("disable")?likevote_text.html("+10"):$.ajax({url:"https://cs.syosetu.org/",type:"POST",data:{nid:nid,volume:volume,line:$(this).data("line")},xhrFields:{withCredentials:!0}}).then((function(data){var parseData=parseInt(data);isNaN(parseData)||parseData<0?alert("ここすきに失敗しました。時間をおいて再実行してください。"):parseData<10?likevote_text.html("+"+parseData):(likevote_text.html("+10"),likevote_text.data("disable",1))}),(function(){alert("ここすきに失敗しました。時間をおいて再実行してください。")})),!1})),$("#honbun p").on("dblclick",(function(e){if(1==data.like)return!0;if(null==document.getElementById("login_user"))return!0;var line_id=$(this).attr("id");if($(".likevote_selected_line").removeClass("likevote_selected_line"),line_id){$(".likevote_tip").remove(),$("body").append('<div data-line="'+line_id+"\"class=\"likevote_tip\" onclick=\"ga('send','event','like','click','"+nid+"_"+volume+"', "+line_id+');"><div class="middle-wrapper"><div class="like-wrapper"><a class="like-button"><span class="like-icon"><div class="heart-animation-1"></div><div class="heart-animation-2"></div></span>ここすき<span class="likevote_text"></span></a></div></div></div>'),$(this).addClass("likevote_selected_line"),likevote_tip=$(".likevote_tip"),e.originalEvent.touches&&(e.pageX=e.originalEvent.touches[0].pageX,e.pageY=e.originalEvent.touches[0].pageY);var likevote_tip_width=likevote_tip.outerWidth(),likevote_tip_height=likevote_tip.outerHeight(),disp_x=e.pageX-150,disp_y=e.pageY+likevote_tip_height/2;window_width=$(window).width(),disp_x<5&&(disp_x+=240),disp_y<$(window).scrollTop()&&(disp_y=$(window).scrollTop()),likevote_tip.css({top:disp_y,left:disp_x,width:likevote_tip_width,height:likevote_tip_height})}return!1})),$(document).on("click","a.like-button",(function(e){clearTimeout(),$(this).removeClass("liked"),$(this).addClass("liked"),setTimeout((function(){$(e.target).removeClass("liked")}),1e3)}));var mona_check=0,o,s;(1!=data.seikei&&1!=data.insert&&1!=data.compress||$(".mona").length>0&&(mona_check=1),1==data.bar_fix?$("#fix_header").text("解除"):$("#fix_header").text("固定"),(1==data.compress||1==data.seikei||1==data.insert||1==data.correct||1==data.voice||1<=data.replace)&&$("#honbun p:not(.footnote_line)").each((function(t,e){$(this).html('<span class="display_text">'+$(this).html()+"</span>")})),1!=data.correct&&1!=data.voice||$("p .display_text").each((function(t,e){$(this).after('<span class="original_text" style="display:none;">'+$(this).html()+"</span>")})),1==data.seikei&&$("p .display_text").each((function(t,e){if(1==mona_check&&$(this).parents(".mona").length>0)return!0;var i=$(this).html();i=i.replace(/－－/gi,"――").replace(/<rt>([・･.]+?)<\/rt>/gi,(function(){return"<rt>"+mult("&#x200B;&#x30FB;&#x200B;",arguments[1].length)+"</rt>"})).replace(/[・･.]{2,3}/gi,"……").replace(/｢/g,"「").replace(/｣/g,"」").replace(/\(/g,"（").replace(/\)/g,"）").replace(/､/g,"、").replace(/｡/g,"。").replace(/……[・･]/gi,"……").replace(/。　/gi,"。").replace(/。([」』）》)｣＞】])/gi,"$1").replace(/([!?！？♪])([^a-zA-Z!?！？♪ 　」』）》\)｣】≫＞\-])/gi,"$1　$2").replace(/^\s+([　 ＜{【「『《≪（\(｢])/gi,"$1").replace(/^ *([^　 ＜【「『《≪（\(\｢<※])/gi,"　$1").replace(/^<span class="\.sesame">/gi,'　<span class=".sesame">').replace(/^<ruby>/gi,"　<ruby>"),$(this).html(i)})),1<=data.replace&&(localStorage.getItem("conv_"+nid)||localStorage.getItem("conv_all"))&&$("p .display_text,p .display_text *").contents().each((function(t,e){if(3==e.nodeType){var i=$(this).text(),i2=i,jsonObj=JSON.parse(localStorage.getItem("conv_"+nid));if(jsonObj)for(let j=0;j<jsonObj.length;j++)i=i.replace(new RegExp(jsonObj[j].b,"g"),jsonObj[j].a);var jsonObj2=JSON.parse(localStorage.getItem("conv_all"));if(jsonObj2)for(let j=0;j<jsonObj2.length;j++)i=i.replace(new RegExp(jsonObj2[j].b,"g"),jsonObj2[j].a);i!=i2&&3==e.nodeType&&(e.nodeValue=i)}})),1==data.compress)&&$("p .display_text").each((function(t,e){return 1==mona_check&&$(this).parents(".mona").length>0||(o?(o=!1,!0):($(this).html().match(/^[ 　]*$/)&&($(this).parent("p").remove(),o=!0),void(s=e)))}));1==data.insert&&$("p .display_text").each((function(t,e){if(1==mona_check&&$(this).parents(".mona").length>0)return!0;var i=$(this).html(),a=$(s).html();$(s).length&&(i.match(/^\s*?[＜【<「『《≪（\(｢]/)&&a.match(/[^」』）》≫\)｣＞】>]\s*$/)||i.match(/^\s*?[^＜【「『《≪（\(｢]/)&&a.match(/[」』）》≫\)｣＞】]\s*$/))&&$(this).parent("p").before("<br>"),s=e}));if(1==data.correct&&($.getScript("https://img.syosetu.org/js/fastClick.min.js"),$.getScript("https://img.syosetu.org/js/jquery.color.plus-names-2.1.2.min.js"),$.getScript("https://img.syosetu.org/js/diff_match_patch.js"),$.getScript("https://img.syosetu.org/js/jquery.pretty-text-diff.min.js"),$.getScript("https://img.syosetu.org/js/jquery.autosize.min.js"),$("#honbun").append('<input type="hidden" name="nid" value="'+nid+'"><input type="hidden" name="volume" value="'+volume+'"><input type="hidden" name="mode" value="correct_end">'),$("#honbun").wrap('<form action="https://syosetu.org/" method="POST" id="correct_form">'),$("#nextpage").append('&nbsp;<a href="" id="correct_submit">誤字報告を送信</a>'),$("#honbun").on("click",".preview",(function(){var t=$(this).parents("p");t.removeClass("selected_line"),t.children(".diff_textarea").hide(),t.children(".display_text").hide(),t.children(".diff_view").show();var e=t.children(".original_text").html(),i=t.children(".diff_textarea").children(".diff_text").val();i=i.replace(/[\n\r]/g,""),t.children(".diff_textarea").children(".diff_text").val(i);for(var a=[],o=/《《(.{0,300}?)》》/g;a=o.exec(i);){for(var s="",n=new RegExp(a[0],"gi"),c=a[1].split(""),r=0;r<c.length;r++)s+="<ruby><rb>"+c[r]+"</rb><rp>(</rp><rt>&#x30FB;</rt><rp>)</rp></ruby>";i=i.replace(n,s)}i=i=(i=(i=i.replace(/\|(.{0,20}?)《(.{0,20}?)》/g,"<ruby><rb>$1</rb><rp>(</rp><rt>$2</rt><rp>)</rp></ruby>")).replace(/《(!|！)《/g,"《《")).replace(/《ruby》(.*?)《rt》(.*?)《\/rt》《\/ruby》/g,"<ruby>$1<rt>$2</rt></ruby>"),t.prettyTextDiff({cleanup:$("#cleanup").is(":checked"),originalContent:e,changedContent:i,diffContainer:".diff_view"}),$(window).on("beforeunload",(function(){return"誤字報告が送信されていません。このまま移動しますか？"}))})),$("#honbun").on("click",".cancel",(function(){if(!confirm("入力内容を取り消しますか"))return!1;var t=$(this).parents("p");t.attr("id"),t.removeClass("selected_line"),t.children(".diff_textarea").remove(),t.children(".diff_view").remove(),t.children(".display_text").show()})),$("#correct_submit").on("click",(function(event){event.preventDefault();var $form=$("#correct_form"),$button=$(this);$.ajax({url:$form.attr("action"),type:$form.attr("method"),data:$form.serialize(),timeout:1e4,beforeSend:function(xhr,settings){$button.attr("disabled",!0)},complete:function(xhr,textStatus){$button.attr("disabled",!1)},success:function(result,textStatus,xhr){confirm("送信が完了しました。"),$(window).off("beforeunload")},error:function(xhr,textStatus,error){alert("送信に失敗しました")}})})),$("#honbun").on("click",".display_text,.diff_view",(function(){$("p").removeClass("selected_line");var e=$(this).parent("p"),i=e.attr("id");if(t(i),e.addClass("selected_line"),e.children(".diff_textarea").length)e.children(".diff_textarea").show(),e.children(".diff_view").hide();else{var a=e.children(".original_text").html(),image_url=e.find('a[name="img"]');if(image_url.length>0){var url=image_url.attr("href");return window.open(url,"_blank"),!1}for(var o=[],s=/<span class="\.sesame">(.*?)<\/span>/;o=s.exec(a);){var n=new RegExp(o[0].replace(/([()])/g,"\\$1"),"gi"),c=o[1].replace(/<.*?>/g,"");c=(c=c.replace(/\(\u30fb\)/g,"")).replace(/\(\u30fd\)/g,""),a=a.replace(n,"《《"+c+"》》")}a=(a=a.replace(/<ruby><rb>(.{0,20}?)<\/rb><rp>\(<\/rp><rt>(.{0,20}?)<\/rt><rp>\)<\/rp><\/ruby>/g,"|$1《$2》")).replace(/<ruby>(.*?)<rt>(.*?)<\/rt><\/ruby>/g,"《ruby》$1《rt》$2《/rt》《/ruby》"),$(this).after('<div class="diff_textarea"><textarea class="diff_text" name="line'+i+'">'+a+'</textarea><table width="100%"><tr><td width="50%"><button class="preview linkbutton" type="button">プレビュー</button></td><td><button class="cancel linkbutton" type="button">キャンセル</button></td></tr></table></div><span class="diff_view"></span>'),$(".diff_text").autosize()}}))),1==data.voice&&window.speechSynthesis){$("#page").after('<div id="footer_bar"><button id="start" class="voice_button"><img src="https://img.syosetu.org/image/start_64.png" width="32" height="32"></button><button id="stop" class="voice_button" style="display:none;"><img src="https://img.syosetu.org/image/stop_64.png" width="32" height="32"></button><button id="setting" class="voice_button"><img src="https://img.syosetu.org/image/setting_64.png" width="32" height="32"></button><div id="voice_setting_menu"><table width="100%"><tr><td>追従</td><td><input type="checkbox" id="autoScroll" value="1"></td></tr><tr><td>音声</td><td><select id="voiceList"><option value="">--</option></select></td></tr><tr><td>速度</td><td><select id="voiceRate"><option value="">--</option></select></td></tr><tr><td>ピッチ</td><td><select id="voicePitch"><option value="">--</option></select></td></tr></table></div>');for(var n=1;n<=20;n++)$("#voiceRate").append('<option value="'+n/10+'">'+n/10+"</option>"),$("#voicePitch").append('<option value="'+n/10+'">'+n/10+"</option>");$("#voiceRate").val("1"),$("#voicePitch").val("1"),$("#container").css("margin-bottom",$("#footer_bar").height());var c=new function(){this.speech=null,this.nowLine=0,this.start=function(){this.speech=new SpeechSynthesisUtterance,this.speech.volume=1,this.speech.rate=1,this.speech.pitch=1,this.speech.text="",this.speech.lang="ja-JP",this.setVoice(),this.speech.onend=this.nextText},this.nextText=function(){if($("p").removeClass("underline"),$("#"+c.nowLine).addClass("underline"),c.nowLine>e)c.stop(),$("button#stop").hide(),$("button#start").show();else{var t=$("#"+c.nowLine+++" .original_text").text();(t=t.replace(/―/gi,"　").replace(/…/gi,"、").replace(/[・･]/gi,"、").replace(/…/gi,"、")).length>0&&$("#autoScroll").prop("checked")&&$("html,body").scrollTop($("#"+(c.nowLine-1)).offset().top-$(window).height()/2),t.length>0?c.talk(t):c.talk("")}},this.stop=function(){speechSynthesis.cancel(),this.speech.onend=null},this.setVoice=function(){"onvoiceschanged"in speechSynthesis?speechSynthesis.onvoiceschanged=this.getVoices:this.getVoices()},this.getVoices=function(){for(var t=speechSynthesis.getVoices(),e="<option value=>-</option>",i=0;i<t.length;i++)"ja-JP"!=t[i].lang&&"ja_JP"!=t[i].lang||(t[i].default&&(c.speech.voice=t[i]),e+='<option value="'+i+'">'+i+"</option>");$("#voiceList").html(e),c.cookieGet()},this.changeVoice=function(t){var e=speechSynthesis.getVoices();t&&99!=t&&(this.speech.voice=e[t])},this.changePitch=function(t){this.speech.pitch=t},this.changeRate=function(t){this.speech.rate=t},this.talk=function(t){this.speech.text=t,this.changeVoice($("#voiceList").val()),speechSynthesis.speak(this.speech);var e=setInterval((function(){speechSynthesis.speaking?speechSynthesis.resume():clearInterval(e)}),14e3)},this.settingSave=function(){var t={};t.voice=$("#voiceList").val(),t.rate=$("#voiceRate").val(),t.pitch=$("#voicePitch").val(),t.autoScroll=$("#autoScroll").prop("checked"),$.cookie("ss_voice_setting",t,{expires:3650,path:"/",domain:".syosetu.org"})},this.cookieGet=function(){var t=$.cookie("ss_voice_setting");null!=t&&(t.rate&&($("#voiceRate").val(t.rate),this.speech.rate=t.rate),t.pitch&&($("#voicePitch").val(t.pitch),this.speech.pitch=t.pitch),t.autoScroll&&$("#autoScroll").prop("checked",!0),t.voice&&($("#voiceList").val(t.voice),this.changeVoice(t.voice)))}};window.addEventListener("beforeunload",(function(){speechSynthesis.cancel()})),c.start(),$("button#start").click((function(){c.talk(""),c.speech.onend=c.nextText,$(this).hide(),$("button#stop").show()})),$("button#stop").click((function(){c.stop(),c.nowLine--,$(this).hide(),$("button#start").show()})),$("button#setting").click((function(){$("#voice_setting_menu").toggle()})),$("#voiceList").change((function(){c.changeVoice($("#voiceList").val()),c.settingSave()})),$("#voicePitch").change((function(){c.changePitch($("#voicePitch").val()),c.settingSave()})),$("#voiceRate").change((function(){c.changeRate($("#voiceRate").val()),c.settingSave()})),$("#autoScroll").change((function(){c.settingSave()})),$("#honbun").on("click",".display_text",(function(){c.nowLine=$(this).parent().attr("id"),$("p").removeClass("underline"),$("#"+c.nowLine).addClass("underline")}))}var r=$("body"),l=$("#header .topicPath"),h=$("#header"),d=$("#honbun"),p=l.offset().top,u=d.offset().top,f=d.height(),g=$("#analytics_end").offset().top,v=parseInt($("#header").css("margin-bottom"),10),m=window.innerHeight?window.innerHeight:$(window).height(),b=function(){var t=new Object,e=location.search.substring(1).split("&");for(n=0;e[n];n++){var i=e[n].split("=");t[i[0]]=i[1]}return t}();isFinite(b.scroll)&&$(window).scrollTop(f*b.scroll/100+u),$("#fix_header").click((function(t){t.preventDefault(),1==data.bar_fix?(data.bar_fix=0,r.removeClass("is-fixed"),h.css("margin-bottom",v),$("#fix_header").text("固定")):(data.bar_fix=1,$("#fix_header").text("解除")),$(".content").toggleClass("hidden"),$.cookie("ss_setting",data,{expires:3650,path:"/",domain:".syosetu.org"})})),$(window).on("scroll",(function(){1==data.bar_fix&&($(this).scrollTop()>p&&g-m>$(this).scrollTop()?(r.addClass("is-fixed"),h.css("margin-bottom",l.outerHeight(!0)+v)):(r.removeClass("is-fixed"),h.css("margin-bottom",v)),g-m>=$(this).scrollTop()&&$(this).scrollTop()>=g-2*m?l.css("opacity",(g-m-$(this).scrollTop())/m):l.css("opacity","1"))}));var x=!0,tip;$(".siori").click((function(t){if(1==data.bar_fix&&(t.preventDefault(),x)){x=!1;var e=($(window).scrollTop()-u)/f*100;$.ajax({type:"GET",url:"https://syosetu.org/?mode=siori_input&nid="+nid+"&volume="+volume+"&scroll="+Math.round(100*e)/100,dataType:"text",cache:!1,xhrFields:{withCredentials:!0},success:function(t){alert("栞保存完了しました。"),x=!0},error:function(t,e){alert("エラー：件数上限・未ログイン状態・通信失敗など"),x=!0}})}})),$(document).on("touchstart mouseenter",".footnote_number:not(.original_text .footnote_number)",(function(e){e.preventDefault();var index=$(".footnote_number:not(.original_text .footnote_number)").index(this);$(this).parent().append('<div class="footnote_tip"></div>'),(tip=$(".footnote_tip")).html($(".footnote_text").eq(index).html()),e.originalEvent.touches&&(e.pageX=e.originalEvent.touches[0].pageX,e.pageY=e.originalEvent.touches[0].pageY);var tip_width=tip.outerWidth()+1,tip_height=tip.outerHeight(),disp_x=e.pageX+0-$("#honbun").offset().left,disp_y=e.pageY-tip_height-20-$("#honbun").offset().top;window_width=$(window).width(),disp_x+tip_width>window_width-$("#honbun").offset().left-3&&(disp_x=-tip_width+window_width-3-$("#honbun").offset().left,tip_width>.9*window_width&&(disp_x=(window_width-tip_width)/2-$("#honbun").offset().left)),disp_y<$(window).scrollTop()&&(disp_y=e.pageY+20-$("#honbun").offset().top),tip.css({top:disp_y,left:disp_x,width:tip_width,height:tip_height})})),$(document).on("touchend mouseleave",".footnote_number",(function(e){e.preventDefault(),tip.remove()})),$(document).on("click",".footnote_number",(function(e){e.preventDefault()})),$(document).on("contextmenu",".footnote_number",(function(e){return!1})),$(".footnote_link").on("click",(function(e){e.preventDefault();var href=$(this).attr("href"),target,position=$("#"==href||""==href?"html":href).offset().top;$("html, body").animate({scrollTop:position},"slow","swing")}));var font_subset_text={},audio;function getInvertedAndHueRotatedColor(element,style_name){var rgb_color=$(element).css(style_name),hue,saturation,lightness,alpha;hue=$.Color(rgb_color).hue(),saturation=$.Color(rgb_color).saturation(),lightness=$.Color(rgb_color).lightness(),alpha=$.Color(rgb_color).alpha();var pr=.298912,pg=.586611,pb=.114478,a,pmax,pmid,yp,c=2*saturation*(.5-((pmax=60<=hue&&hue<180?pg:180<=hue&&hue<300?pb:pr)+(pmid=0<=hue&&hue<60||180<=hue&&hue<240?pg:120<=hue&&hue<180||300<=hue&&hue<360?pb:pr)*(a=0<=hue&&hue<60||120<=hue&&hue<180||240<=hue&&hue<300?hue%60/60:1-hue%60/60))),y,new_y=1-(y=lightness>.5?lightness*(1+c)-c:lightness*(1-c)),l;l=new_y>(1-c)/2?(new_y+c)/(1+c):new_y/(1-c);var new_rgb=$.Color().hsla(hue,saturation,l,alpha);$(element).css(style_name,new_rgb)}function setVideo(path){if(Hls.isSupported()){var config,hls=new Hls({defaultAudioCodec:"mp4a.40.29",enableWebVTT:!1,enableCEA708Captions:!1,maxBufferLength:50,enableSoftwareAES:!0,maxAudioFramesDrift:1e7});return hls.loadSource(path),hls.attachMedia(audio),hls.on(Hls.Events.LEVEL_PTS_UPDATED,onLevelPtsUpdated),audio.play()}return audio.canPlayType("application/vnd.apple.mpegurl")?(audio.src=path,audio.play()):audio.play()}$(".webfont_subset").each((function(){var font_family=$(this).css("font-family");void 0===font_subset_text[font_family]&&(font_subset_text[font_family]=""),font_subset_text[font_family]+=$(this).text()})),Object.keys(font_subset_text).length<=20?Object.keys(font_subset_text).forEach((function(font_family){var text,origin_chars=this[font_family].split(""),unique_obj={};origin_chars.forEach((function(char){unique_obj[char]=1}));var unique_chars=Object.keys(unique_obj).join(""),method_type="GET";unique_chars.length>500&&(method_type="POST");var cache_type=!0;font_family.match(/^f-u/)&&(cache_type=!1),$.ajax({url:"https://syosetu.org/font_subset/",data:{font_family:font_family,text:unique_chars,nid:nid},type:method_type,dataType:"text",cache:cache_type}).then((function(data){var style;$('<style type="text/css">'+data+"</style>").appendTo("head")}),(function(){console.log("読み込み失敗")}))}),font_subset_text):console.log("フォント種類数制限:20"),$("body.night .color:not(.bgcolor .color):not(.original_text .color)").each((function(t,e){getInvertedAndHueRotatedColor(this,"color")})),$("body.night .bordercolor:not(.bgcolor .bordercolor):not(.original_text .bordercolor)").each((function(t,e){getInvertedAndHueRotatedColor(this,"border-color")})),$("body.night .strokecolor:not(.bgcolor .strokecolor):not(.original_text .strokecolor)").each((function(t,e){getInvertedAndHueRotatedColor(this,"-webkit-text-stroke-color")})),$("#nightmode_check").click((function(){$(".color:not(.bgcolor .color):not(.original_text .color)").each((function(t,e){getInvertedAndHueRotatedColor(this,"color")})),$(".bordercolor:not(.bgcolor .bordercolor):not(.original_text .bordercolor)").each((function(t,e){getInvertedAndHueRotatedColor(this,"border-color")})),$(".strokecolor:not(.bgcolor .strokecolor):not(.original_text .strokecolor)").each((function(t,e){getInvertedAndHueRotatedColor(this,"-webkit-text-stroke-color")}))})),$("#enquete_box").length>0&&$.ajax({url:"https://cs.syosetu.org/",type:"POST",data:{enquete_id:$("#enquete_box").data("enquete-id")},xhrFields:{withCredentials:!0}}).done((function(data){if($(".votable").show(),0!=data.length){var enqueteObj=JSON.parse(data);for(var i in enqueteObj.count){var answer_box=$("#enquete_box li:eq("+(i-1)+")"),vote_num=enqueteObj.count[i];(!enqueteObj.sum||enqueteObj.sum<1)&&(enqueteObj.sum=1),(!vote_num||vote_num<1)&&(vote_num=0);var parcent=Math.round(vote_num/enqueteObj.sum*100);answer_box.find(".enquete_perc").html(vote_num+" / "+parcent+"%"),answer_box.find(".bgcolor").width(parcent+"%")}$("#enquete_box").removeClass("votable"),$("#enquete_box li:eq("+(enqueteObj.selected-1)+") .answer_text").addClass("selected"),$(".enquete_view").off("click")}})),$("#enquete_box.votable .enquete_view").on("click",(function(){if(!confirm($(this).data("answer-id")+"に投票しますか？"))return e.preventDefault(),!1;$.ajax({url:"https://cs.syosetu.org/",type:"POST",data:{enquete_id:$("#enquete_box").data("enquete-id"),answer_id:$(this).data("answer-id")},xhrFields:{withCredentials:!0}}).done((function(data){if(0!=data.length){var enqueteObj=JSON.parse(data);for(var i in enqueteObj.count){var answer_box=$("#enquete_box li:eq("+(i-1)+")"),vote_num=enqueteObj.count[i];(!enqueteObj.sum||enqueteObj.sum<1)&&(enqueteObj.sum=1),(!vote_num||vote_num<1)&&(vote_num=0);var parcent=Math.round(vote_num/enqueteObj.sum*100);answer_box.find(".enquete_perc").html(vote_num+" / "+parcent+"%"),answer_box.find(".bgcolor").width(parcent+"%")}$("#enquete_box").removeClass("votable"),$("#enquete_box li:eq("+(enqueteObj.selected-1)+") .answer_text").addClass("selected"),$(".enquete_view").off("click")}else alert("投票できませんでした。ログイン状態かどうかご確認ください。")})).fail((function(data){alert("投票できませんでした。サーバーエラーが発生した可能性があります。")}))}));var ttsStatus={nowSpeakLine:0,timeList:[],timeDiffList:[],fragmentStartList:[],fragmentInitialStartList:[]},ttsConfig={voiceTalker:0,voiceRate:1.2,autoScroll:1,autoPager:0},ttsNowAutoPaging;function setTtsSetting(){var obj=JSON.stringify(ttsConfig);localStorage.setItem("ttsConfig",obj)}function getTtsSetting(){var jsonObj=localStorage.getItem("ttsConfig");jsonObj&&(ttsConfig=JSON.parse(jsonObj),audio.defaultPlaybackRate=ttsConfig.voiceRate,$("#tts_voiceRate").val(ttsConfig.voiceRate),$("#tts_voiceTalker").val(ttsConfig.voiceTalker),ttsConfig.autoScroll&&$("#tts_autoScroll").prop("checked",!0),ttsConfig.autoPager&&$("#tts_autoPager").prop("checked",!0))}function onLevelPtsUpdated(event,data){if(ttsStatus.fragmentStartList.length)for(var i in ttsStatus.fragmentStartList)ttsStatus.fragmentStartList[i]!=data.details.fragments[i].start&&(ttsStatus.timeDiffList[parseInt(ttsStatus.fragmentInitialStartList[i]/59)]=data.details.fragments[i].start-ttsStatus.fragmentInitialStartList[i]),ttsStatus.fragmentStartList[i]=data.details.fragments[i].start;else{for(var j in ttsStatus.fragmentStartList.length=data.details.fragments.length,data.details.fragments)ttsStatus.fragmentStartList[j]=data.details.fragments[j].start;ttsStatus.fragmentInitialStartList=ttsStatus.fragmentStartList.slice()}}function ttsLoad(){$.ajax({url:"https://voice.syosetu.org/",data:{mode:"get_tts",nid:nid,volume:volume,type:ttsConfig.voiceTalker},type:"POST",dataType:"json",cache:!1}).then((function(data){if("description"in data)return alert(data.description),!1;var sum_time=0;for(var k in setVideo("data:application/x-mpegURL;base64,"+data.data),ttsStatus.timeList=[],data.time)ttsStatus.timeList.push(sum_time),sum_time+=data.time[k];ttsStatus.timeDiffList=new Array(parseInt(sum_time/59)).fill(0)}),(function(){$("button#tts_start").show(),$("button#tts_stop").hide(),alert("音声の読み込みに失敗しました。生成中もしくは読み上げ機能の対象外の可能性があります。"),console.log("読み込み失敗")}))}$(".tts_menu_start").on("click",(function(){$("#honbun p").on("click",(function(){void 0!==audio&&(ttsStatus.nowSpeakLine=parseInt($(this).attr("id")),audio.currentTime=ttsStatus.timeList[ttsStatus.nowSpeakLine]-.3+ttsStatus.timeDiffList[parseInt(audio.currentTime/59)],1==ttsConfig.autoScroll&&($("html,body").animate({scrollTop:$("#honbun p#"+ttsStatus.nowSpeakLine).offset().top-1*$(window).height()/3}),$("#honbun p").css("text-decoration","none"),$("#honbun p#"+ttsStatus.nowSpeakLine).css("text-decoration","underline")))})),$.getScript("https://cdn.jsdelivr.net/npm/hls.js@1.4.14").done((function(script,textStatus){$("<audio>").attr({id:"audio"}).appendTo("body"),(audio=document.getElementById("audio")).addEventListener("timeupdate",(function(e){if(ttsStatus.nowSpeakLine+1<=ttsStatus.timeList.length&&ttsStatus.timeList[ttsStatus.nowSpeakLine+1]-.3+ttsStatus.timeDiffList[parseInt(audio.currentTime/59)]<=audio.currentTime){ttsStatus.nowSpeakLine+=1;for(var tmpLine=ttsStatus.nowSpeakLine,i=ttsStatus.nowSpeakLine+1;i<ttsStatus.timeList.length;i++)ttsStatus.timeList[tmpLine]==ttsStatus.timeList[i]&&(ttsStatus.nowSpeakLine+=1);1==ttsConfig.autoScroll&&($("html,body").animate({scrollTop:$("#honbun p#"+ttsStatus.nowSpeakLine).offset().top-1*$(window).height()/3}),$("#honbun p").css("text-decoration","none"),$("#honbun p#"+ttsStatus.nowSpeakLine).css("text-decoration","underline"))}})),audio.addEventListener("ended",(function(e){$("button#tts_start").show(),$("button#tts_stop").hide(),1==ttsConfig.autoPager&&audio.currentTime>0&&$(".next_page_link").length>0&&(localStorage.setItem("ttsNowAutoPaging",1),$(".next_page_link")[0].click())})),$(".tts_menu_start").off(),$("#footer_bar").remove(""),$("body").append('<div id="footer_bar"><button id="tts_start" class="voice_button"><img src="https://img.syosetu.org/image/start_64.png" width="32" height="32"></button><button id="tts_stop" class="voice_button" style="display:none;"><img src="https://img.syosetu.org/image/stop_64.png" width="32" height="32"></button><button id="tts_setting" class="voice_button"><img src="https://img.syosetu.org/image/setting_64.png" width="32" height="32"></button><div id="tts_voice_setting_menu" class="voice_setting_menu"><table width="100%"><tr><td colspan="2"><select id="tts_voiceTalker"><option value="0">結月ゆかり</option><option value="1">東北きりたん</option></select></td></tr><tr><td>速度</td><td><select id="tts_voiceRate"><option value="1.0">--</option><option value="0.5">0.5</option><option value="0.6">0.6</option><option value="0.7">0.7</option><option value="0.8">0.8</option><option value="0.9">0.9</option><option value="1.0" selected>1.0</option><option value="1.1">1.1</option><option value="1.2">1.2</option><option value="1.3">1.3</option><option value="1.4">1.4</option><option value="1.5">1.5</option><option value="1.6">1.6</option><option value="1.7">1.7</option><option value="1.8">1.8</option><option value="1.9">1.9</option><option value="2.0">2.0</option><option value="2.5">2.5</option><option value="3.0">3.0</option><option value="3.5">3.5</option><option value="4.0">4.0</option><option value="4.5">4.5</option><option value="5.0">5.0</option></select></td></tr><tr><td>追従</td><td><input type="checkbox" id="tts_autoScroll" value="1"></td></tr><tr><td>自動次話</td><td><input type="checkbox" id="tts_autoPager" value="1"></td></tr></table></div>'),getTtsSetting(),ttsLoad(),audio.load(),$("button#tts_start").hide(),$("button#tts_stop").show();let startPlayPromise=audio.play();void 0!==startPlayPromise&&startPlayPromise.catch(error=>{"NotAllowedError"===error.name&&($("button#tts_stop")[0].click(),audio.currentTime=0,$(document).on("click.tts",(function(e){$(e.target).closest(".tts_menu_start").length||($(".modal-container").removeClass("active"),$("button#tts_start")[0].click()),$(this).off("click.tts")})),$("<div>").attr({class:"modal-container active"}).appendTo("body"),$(".modal-container").html('<div class="modal-body"><div class="modal-close">×</div><div class="modal-content"><p>自動再生がブラウザにブロックされました。<br>画面をクリックして下さい。</p></div></div>'))}).then(()=>{console.log("音声の自動再生に成功しました。")})})).fail((function(jqxhr,settings,exception){alert("jsファイルの読み込みに失敗しました。")}))})),1==localStorage.getItem("ttsNowAutoPaging")&&(localStorage.setItem("ttsNowAutoPaging",0),$(".tts_menu_start")[0].click()),$(document).on("click","button#tts_setting",(function(){$("#tts_voice_setting_menu").toggle()})),$(document).on("click","button#tts_start",(function(){$(this).hide(),$("button#tts_stop").show(),audio.currentTime=ttsStatus.timeList[ttsStatus.nowSpeakLine],audio.play()})),$(document).on("click","button#tts_stop",(function(){$(this).hide(),$("button#tts_start").show(),audio.pause()})),$(document).on("change","#tts_voiceTalker",(function(){ttsConfig.voiceTalker=$(this).val(),audio.pause(),ttsLoad(),ttsStatus.fragmentStartList=[],ttsStatus.fragmentInitialStartList=[],ttsStatus.timeDiffList=[],$("button#tts_start").show(),$("button#tts_stop").hide(),setTtsSetting(),getTtsSetting()})),$(document).on("change","#tts_voiceRate",(function(){audio.playbackRate=$(this).val(),ttsConfig.voiceRate=$(this).val(),setTtsSetting()})),$(document).on("change","#tts_autoScroll",(function(){$(this).prop("checked")?ttsConfig.autoScroll=1:ttsConfig.autoScroll=0,setTtsSetting()})),$(document).on("change","#tts_autoPager",(function(){$(this).prop("checked")?ttsConfig.autoPager=1:ttsConfig.autoPager=0,setTtsSetting()}))}));